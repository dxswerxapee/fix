import random
import string
import qrcode
from io import BytesIO
import logging

logger = logging.getLogger(__name__)

def generate_captcha():
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ°Ğ¿Ñ‡Ñƒ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ğ¾Ğ³Ğ¾"""
    animals = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ']
    correct_animal = random.choice(animals)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ· 6 Ğ¶Ğ¸Ğ²Ğ¾Ñ‚Ğ½Ñ‹Ñ…, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹
    options = [correct_animal]
    while len(options) < 6:
        animal = random.choice(animals)
        if animal not in options:
            options.append(animal)
    
    # ĞŸĞµÑ€ĞµĞ¼ĞµÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹
    random.shuffle(options)
    
    return {
        'correct_animal': correct_animal,
        'options': options
    }

def generate_crypto_address(crypto_type):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ (Ğ´Ğ»Ñ Ğ´ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸)"""
    addresses = {
        'TRC20': 'TUfach6g9gPDBTrRsy1jMWfd37z6RQLEB4',
        'BTC': '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa',
        'BNB': 'bnb1grpf0955h0ykzq3ar5nmum7y6gdfl6lxfn46h2',
        'TRON': 'TLPpXqSKqKWAjQTwKzYqnRkUJEK69A2HE9'
    }
    return addresses.get(crypto_type, addresses['TRC20'])

def generate_qr_code(data):
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ QR ĞºĞ¾Ğ´ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞµĞ³Ğ¾ ĞºĞ°Ğº BytesIO Ğ¾Ğ±ÑŠĞµĞºÑ‚"""
    try:
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_L,
            box_size=10,
            border=4,
        )
        qr.add_data(data)
        qr.make(fit=True)
        
        img = qr.make_image(fill_color="black", back_color="white")
        
        bio = BytesIO()
        img.save(bio, format='PNG')
        bio.seek(0)
        
        return bio
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ QR ĞºĞ¾Ğ´Ğ°: {e}")
        return None

def format_deal_status(status):
    """Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞ´ĞµĞ»ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ"""
    status_map = {
        'waiting_partner': 'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ°',
        'waiting_payment': 'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹',
        'payment_sent': 'ĞĞ¿Ğ»Ğ°Ñ‚Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°',
        'completed': 'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°',
        'cancelled': 'ĞÑ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°'
    }
    return status_map.get(status, status)

def format_role(deal_id, user_id, seller_id, buyer_id):
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² ÑĞ´ĞµĞ»ĞºĞµ"""
    if user_id == seller_id:
        return 'ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†'
    elif user_id == buyer_id:
        return 'ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ'
    else:
        return 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'

def validate_amount(amount_str):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ ÑÑƒĞ¼Ğ¼Ñ‹"""
    try:
        amount = float(amount_str)
        if amount <= 0:
            return None, "Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0"
        if amount > 1000000:
            return None, "Ğ¡ÑƒĞ¼Ğ¼Ğ° ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ"
        return amount, None
    except ValueError:
        return None, "ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑÑƒĞ¼Ğ¼Ñ‹"

def validate_password(password):
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ"""
    if len(password) < 4:
        return False, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 4 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°"
    if len(password) > 50:
        return False, "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹"
    return True, None